<!-- =============================================================================
     TEMPLATE: FORMULARIO PARA CREAR NUEVA TAREA
     =============================================================================
     Esta página muestra un formulario para crear una nueva tarea
     
     CONCEPTOS CLAVE:
     - Formulario HTML: Permite al usuario enviar datos al servidor
     - method="post": Los datos se envían de forma segura (no visibles en la URL)
     - action="/crear": La URL donde se envían los datos del formulario
     - name="title": Identifica el campo en el servidor (request.form["title"])
     - Bootstrap: Clases CSS para estilizar el formulario
     ============================================================================= -->
<!-- Heredamos la estructura del template layout.html -->
{% extends "layout.html" %}
<!-- Definimos el título del documento de esta página -->
{% block title %}Nueva Tarea{% endblock %}
<!-- Definimos el contenido específico de esta página -->
{% block content %}
<!-- Título de la página -->
<h1>Nueva Tarea</h1>
<!-- FORMULARIO HTML -->
<!-- action="/crear" = URL donde se envían los datos -->
<!-- method="post" = Método HTTP para enviar datos de forma segura -->
<form action="/editar/{{ tarea.id }}" method="post" id="editar-tarea-form" data-id="{{ tarea.id }}">
  <!-- ETIQUETA DEL CAMPO -->
  <!-- for="nombre" = Asocia la etiqueta con el campo de entrada -->
  <!-- form-label = Clase de Bootstrap para estilizar etiquetas -->
  <label class="form-label" for="nombre">Título de la tarea</label>
  <!-- CAMPO DE ENTRADA -->
  <!-- name="title" = Nombre del campo (se usa en request.form["title"]) -->
  <!-- class="form-control" = Estilo de Bootstrap para campos de entrada -->
  <!-- type="text" = Tipo de entrada (texto) -->
  <!-- id="nombre" = Identificador único del campo (se asocia con for="nombre") -->
  <input name="title" class="form-control" value="{{ tarea.nombre }}" type="text" id="nombre">
  <!-- Selección de categoría -->
  <br>
  <label class="form-label" for="categoria">Categoría</label>
  <select
    id="categoria"
    name="categoria"
    placeholder="Selecciona o crea una categoría"
    class="form-control"
  >
    <option value="" disabled>Selecciona una categoría</option>
    {% if categorias %}
      {% for cat in categorias %}
        {% set is_selected = (cat.id|string) == (tarea.categoria_id|string) %}
    <option value="{{ cat.nombre }}" {% if is_selected %}selected{% endif %}>{{ cat.nombre }}</option>
    {% endfor %}
    {% endif %}
  </select>
  <!-- Fecha límite -->
  <br>
  <label class="form-label" for="fecha_limite">Fecha límite (opcional)</label>
  <input name="fecha_limite" class="form-control" type="date" id="fecha_limite" value="{{ tarea.fecha_limite if tarea.fecha_limite else '' }}">
  <!-- Prioridad -->
  <br>
  <label class="form-label" for="prioridad">Prioridad</label>
  <select name="prioridad" class="form-control" id="prioridad">
    {% if tarea.prioridad == 'baja' %}
    <option value="baja" selected>Baja</option>
    {% else %}
    <option value="baja">Baja</option>
    {% endif %}
    {% if tarea.prioridad == 'media' %}
    <option value="media" selected>Media</option>
    {% else %}
    <option value="media">Media</option>
    {% endif %}
    {% if tarea.prioridad == 'alta' %}
    <option value="alta" selected>Alta</option>
    {% else %}
    <option value="alta">Alta</option>
    {% endif %}
  </select>
  <!-- Tiempo estimado -->
  <br>
  <label class="form-label" for="tiempo_estimado">Tiempo estimado (minutos)</label>
  <input name="tiempo_estimado" class="form-control" type="number" id="tiempo_estimado" min="0" placeholder="Ej: 30" value="{{ tarea.tiempo_estimado if tarea.tiempo_estimado else '' }}">
  <!-- Espaciado -->
  <br>
  <!-- BOTÓN DE ENVÍO -->
  <!-- type="submit" = Botón que envía el formulario -->
  <!-- class="btn btn-primary" = Estilo de botón azul de Bootstrap -->
  <button type="submit" class="btn btn-primary">
    <i class="bi bi-save me-1"></i>
    Guardar
  </button>
</form>
<!-- Tom Select: permite crear opciones nuevas al vuelo sin jQuery -->
<link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    var el = document.getElementById('categoria');
    if (el) {
      new TomSelect(el, {
        create: function(input) {
          // Devuelve un objeto con value/label para crear una nueva categoría
          return { value: input, text: input };
        },
        createOnBlur: true,
        persist: false,
        allowEmptyOption: true,
        placeholder: 'Selecciona o crea una categoría'
      });
    }
    // Interceptar formulario de editar tarea (action="/editar/:id") para usar PATCH /api/tarea/:id
    const form = document.querySelector('#editar-tarea-form');
    form.addEventListener('submit', async (ev) => {
      ev.preventDefault();
      
      const id = form.getAttribute('data-id');
      const nombre = document.querySelector('#nombre').value.trim();
      const categoria = document.querySelector('#categoria').value.trim();
      const fecha_limite = document.querySelector('#fecha_limite').value || null;
      const prioridad = document.querySelector('#prioridad').value;
      const tiempo_estimado = document.querySelector('#tiempo_estimado').value ? 
        parseInt(document.querySelector('#tiempo_estimado').value) : null;
      
      try {
        await apiFetch(`/api/tarea/${id}`, {
          method: 'PATCH',
          body: JSON.stringify({ 
            nombre, 
            categoria, 
            fecha_limite, 
            prioridad, 
            tiempo_estimado 
          })
        });
        window.location.href = `/tarea/${id}`;
      } catch (err) {
        showFlash(err.message || 'No se pudo actualizar la tarea', 'danger');
      }
    });
  });
</script>
{% endblock %}