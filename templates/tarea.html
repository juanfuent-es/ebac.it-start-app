<!-- =============================================================================
     TEMPLATE: DETALLE DE TAREA
     ============================================================================= -->
{% extends "layout.html" %}
{% block title %}Detalle de Tarea{% endblock %}
{% block content %}
<section id="tarea" class="container mt-4">
  <div class="row justify-content-center">
    <div class="col-12 col-lg-8">
      <div class="card shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h2 class="h5 mb-0">{{ tarea.nombre }}</h2>
          <span class="badge {{ 'bg-success' if tarea.estado == 'completada' else 'bg-secondary' }}">{{ tarea.estado|title }}</span>
        </div>
        <div class="card-body">
          <dl class="row mb-0">
            <dt class="col-sm-4">Categoría</dt>
            <dd class="col-sm-8">{{ categoria.nombre }}</dd>
            <dt class="col-sm-4">Prioridad</dt>
            <dd class="col-sm-8">
              <span class="badge 
                {% if tarea.prioridad == 'alta' %}bg-danger
                {% elif tarea.prioridad == 'media' %}bg-warning
                {% else %}bg-info{% endif %}">
                {{ tarea.prioridad|title }}
              </span>
            </dd>
            {% if tarea.fecha_limite %}
            <dt class="col-sm-4">Fecha límite</dt>
            <dd class="col-sm-8">
              <span>
                {% if 'T' in tarea.fecha_limite %}
                  {{ tarea.fecha_limite.replace('T', ' ') }}
                {% else %}
                  {{ tarea.fecha_limite }}
                {% endif %}
              </span>
              {% if tarea.estado != 'completada' %}
              <small class="text-danger">(Revisar fecha)</small>
              {% endif %}
            </dd>
            {% endif %}
            
            {% if tarea.tiempo_estimado %}
            <dt class="col-sm-4">Tiempo estimado</dt>
            <dd class="col-sm-8">{{ tarea.tiempo_estimado }} minutos</dd>
            {% endif %}
            <dt class="col-sm-4">Creada</dt>
            <dd class="col-sm-8"><small class="text-muted">{{ tarea.fecha_creacion }}</small></dd>
            {% if tarea.completado_en %}
            <dt class="col-sm-4">Completada</dt>
            <dd class="col-sm-8"><small class="text-success">{{ tarea.completado_en }}</small></dd>
            {% endif %}
            <dt class="col-sm-4">Actualizada</dt>
            <dd class="col-sm-8"><small class="text-muted">{{ tarea.fecha_actualizacion }}</small></dd>
          </dl>
        </div>
        <div class="card-footer d-flex gap-2">
          <form action="/tarea/{{ tarea.id }}/toggle-estado" method="post" class="m-0 p-0" data-id="{{ tarea.id }}" id="toggle-estado-form">
            {% set es_completada = tarea.estado == 'completada' %}
            <button type="submit" class="btn {{ 'btn-warning' if es_completada else 'btn-success' }}">
              {% if es_completada %}
              <i class="bi bi-arrow-counterclockwise me-1"></i>
              Marcar como pendiente
              {% else %}
              <i class="bi bi-check2-circle me-1"></i>
              Marcar como completada
              {% endif %}
            </button>
          </form>
          <a href="/editar/{{ tarea.id }}" class="btn btn-primary">
            <i class="bi bi-pencil-square me-1"></i>
            Editar
          </a>
          <a href="/" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-1"></i>
            Volver
          </a>
        </div>
      </div>
    </div>
  </div>
</section>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.querySelector('#toggle-estado-form');
    if (!form) return;
    form.addEventListener('submit', async (ev) => {
      ev.preventDefault();  
      const id = form.getAttribute('data-id');
      // Obtener estado actual desde badge si está disponible
      const badge = document.querySelector('#tarea .badge');
      const estadoActual = badge ? badge.textContent.trim().toLowerCase() : null;
      const nuevoEstado = estadoActual === 'completada' ? 'pendiente' : 'completada';
      try {
        await apiFetch(`/api/tarea/${id}/toggle-estado`, {
          method: 'PATCH',
          body: JSON.stringify({ estado: nuevoEstado })
        });
        window.location.reload();
      } catch (err) {
        showFlash(err.message || 'No se pudo cambiar el estado', 'danger');
      }
    });
  });
</script>
{% endblock %}